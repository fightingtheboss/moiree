<% description("Grid of critic ratings for #{@edition.code}") %>
<% open_graph(@edition) %>

<%= render partial: "shared/edition_nav", locals: { edition: @edition } %>

<div class="overflow-x-auto overflow-y-scroll h-[calc(100vh-4.375rem)] w-full">
  <%= turbo_frame_tag "edition-ratings" do %>

    <header class="p-4 text-left w-full sticky top-0 left-0">
      <div class="flex justify-between">
        <div>
          <h2 class="font-normal text-xs uppercase"><%= @edition.name %></h2>
          <h1 class="font-semibold text-2xl"><%= @edition.code %></h1>
          <p class="mt-1 text-sm">Ratings are out of 5.0</p>
        </div>
        <div class="text-right">
          <% if params[:critics].present? %>
            <p class="text-xs">Currently hiding <strong><%= pluralize(params[:critics].size, "critic")%></strong></p>
            <p class="text-xs"><%= link_to "Reset critic filter", edition_path(@edition), data: { "turbo-action": "advance" }, class: "underline mt-1 inline-block" %></p>
          <% end %>
        </div>
      </div>
      <% if @edition.ratings.any? %>
        <div class="mt-2 flex gap-4 items-center">
          <% if params[:saf] == "false" || (params[:saf].nil? && @edition.current?) %>
            <p class="text-sm font-semibold">Only showing films with ratings</p>
            <%= link_to "Show all films", edition_path(@edition, request.query_parameters.merge(saf: true)), data: { "turbo-action": "advance" }, class: "inline-block bg-indigo-500 hover:bg-indigo-700 text-white font-semibold py-1 px-2 rounded-sm text-xs" %>
          <% elsif params[:saf] == "true" || params[:saf].nil? %>
            <p class="text-sm font-semibold">Showing all films</p>
            <%= link_to "Only show films with ratings", edition_path(@edition, request.query_parameters.merge(saf: false)), data: { "turbo-action": "advance" }, class: "inline-block bg-indigo-500 hover:bg-indigo-700 text-white font-semibold py-1 px-2 rounded-sm text-xs" %>
          <% end %>
        </div>
      <% end %>
    </header>

    <% cache @edition do %>
      <table class="border-separate border-spacing-0 bg-white table-fixed w-full overflow-clip">
        <thead class="">
          <tr class="">
            <th scope="col" class="border border-indigo-100 p-2 sticky top-0 left-0 z-20 bg-white w-[33vw] md:w-36 h-48">Film</th>
            <th scope="col" class="border border-indigo-100 p-2 sticky top-0 z-10 bg-white w-24 h-48">Avg</th>
              <%= render partial: "critic_header", collection: @critics, as: :critic, cache: true %>
          </tr>
        </thead>

        <% @selections_by_category.each do |category, selections| %>
          <tbody class="">
            <tr>
              <th class="sticky left-0 top-48 z-30 bg-indigo-900 text-white text-left w-full" colspan="100%">
                <h3 class="px-2 py-1 text-xs uppercase"><%= category.name %></h3>
              </th>
            </tr>
            <%= render partial: "selection_row", collection: selections, as: :selection, locals: { ratings: @ratings, critics: @critics, film_directors: @film_directors }, cache: true %>
          </tbody>
        <% end %>
      </table>
    <% end %>
  <% end %>
</div>

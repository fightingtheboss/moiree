<div class="overflow-x-auto overflow-y-scroll h-[calc(100vh-2rem)] w-full">
  <%= turbo_frame_tag "edition-ratings" do %>
    <header class="p-4 md:px-8 text-left w-full sticky top-0 left-0">
      <div class="flex justify-between">
        <div>
          <h2 class="font-normal text-xs uppercase"><%= @edition.name %></h2>
          <h1 class="font-semibold text-2xl"><%= @edition.code %></h1>
        </div>
        <div class="text-right">
          <% if params[:critics].present? %>
            <p class="text-xs">Currently hiding <strong><%= params[:critics].size %></strong> critics</p>
            <p class="text-xs"><%= link_to "Reset critic filter", edition_path(@edition), data: { "turbo-action": "advance" }, class: "underline mt-1 inline-block" %></p>
          <% end %>
        </div>
      </div>
    </header>

    <table class="border-separate border-spacing-0 bg-white table-fixed w-max md:w-full overflow-clip">
      <thead class="">
        <tr class="">
          <th scope="col" class="border border-indigo-100 p-2 sticky top-0 left-0 z-20 bg-white w-[25vw] md:w-36">Film</th>
          <th scope="col" class="border border-indigo-100 p-2 sticky top-0 z-10 bg-white md:w-24">Avg</th>
          <% @critics.each do |critic| %>
            <th scope="col" class="border border-indigo-100 p-2 sticky top-0 z-10 bg-white w-24 hover:after:h-[10000px] hover:after:left-0 hover:after:absolute hover:after:top-[-5000px] hover:after:w-full hover:after:-z-0 hover:after:bg-indigo-600/10">
              <div class="flex flex-col justify-between items-stretch max-h-48 w-full relative z-10">
                <div class="[writing-mode:vertical-rl] text-left basis-full">
                  <p><%= critic.name %></p>
                  <p class="text-sm font-light italic"><%= critic.publication %></p>
                </div>
                <p class="text-sm"><%= Country[critic.country].emoji_flag %></p>
                <p class="font-normal text-xs mt-1 opacity-0 hover:opacity-100"><%= link_to "Hide", edition_path(@edition, request.query_parameters.merge("critics[]" => critic.id)), data: { "turbo-action": "advance" } %></p>
              </div>
            </th>
          <% end %>
        </tr>
      </thead>

      <% @selections_by_category.each do |category, selections| %>
        <tbody class="text-sm">
          <tr>
            <th class="sticky left-0 top-52 z-30 bg-indigo-900 text-white">
              <h3 class="px-4 py-1 text-xs uppercase"><%= category.name %></h3>
            </th>
            <th colspan="1000" class="bg-indigo-900 text-white sticky top-52 z-20">&nbsp;</th>
          </tr>
          <% selections.each do |selection| %>
            <tr class=" hover:bg-indigo-600/10">
              <th scope="row" class="border p-2 sticky left-0 z-10 bg-white"><%= selection.film.title %></th>
              <td class="border p-2 text-center font-semibold"><%= number_with_precision(selection.ratings.where(critic: @critics).average(:score), precision: 1) %></td>
              <% @critics.each do |critic| %>
                <% if (rating = @ratings[critic][selection]) %>
                  <td class="border p-2 text-center relative hover:border-indigo-600 hover:after:h-[10000px] hover:after:left-0 hover:after:absolute hover:after:top-[-5000px] hover:after:w-full hover:after:-z-0 hover:after:bg-indigo-600/10"><%= rating.score %></td>
                <% else %>
                  <td class="border p-2 text-center relative hover:border-indigo-600 hover:after:h-[10000px] hover:after:left-0 hover:after:absolute hover:after:top-[-5000px] hover:after:w-full hover:after:-z-0 hover:after:bg-indigo-600/10">&nbsp;</td>
                <% end %>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    </table>
  <% end %>
</div>

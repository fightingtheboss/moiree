<%= turbo_frame_tag "add-film-to-edition" do %>
  <%# Clear out any search results when this Turbo Frame is re-rendered %>
  <%= turbo_stream.update "new-film-search-results", "" %>

  <%= render partial: "shared/errors", locals: { model: selection } %>

  <%= form_with(model: [:admin, edition.festival, edition, selection]) do |selection_form| %>
    <%= selection_form.fields_for :film do |form| %>
      <% if selection.new_record? && film.persisted? %>
        <div class="mb-4">
          <%= render partial: "admin/films/film_detail", locals: { film: film } %>
        </div>
      <% else %>
        <div class="grid grid-cols-5 gap-2" data-controller="search" data-search-url-value="<%= admin_festival_edition_search_for_film_to_add_path(edition.festival, edition, selection_id: selection.id) %>">
          <div class="col-span-4">
            <%= form.label :title, class: "block text-gray-700 text-sm font-bold mb-2" %>
            <%= form.text_field :title, placeholder: "e.g. Anatomy of a Fall", data: { action: "input->search#existing", "search-target": "query" }, class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-xs ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" %>
          </div>
          <div class="col-span-1">
            <%= form.label :year, class: "block text-gray-700 text-sm font-bold mb-2" %>
            <%= form.number_field :year, min: 1900, max: Time.now.year, step: 1, value: form.object.year || @edition.year, data: { action: "input->search#existing", "search-target": "year" }, class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-xs ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" %>
          </div>
        </div>

        <ul id="<%= dom_id(@edition, :new_film) %>" class="w-full mb-4">
            <%= turbo_frame_tag "new-film-search-results", src: (admin_festival_edition_search_for_film_to_add_path(@festival, @edition, query: film.title, year: film.year, selection_id: selection.id) if film.tmdb_id.blank?) do %>
          <% end %>
        </ul>

        <div class="mb-4">
          <%= form.label :original_title, class: "block text-gray-700 text-sm font-bold mb-2" %>
          <%= form.text_field :original_title, placeholder: "e.g. Anatomie d'une chute", class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-xs ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" %>
        </div>
        <div class="mb-4">
          <%= form.label :director, class: "block text-gray-700 text-sm font-bold mb-2" %>
          <%= form.text_field :director, placeholder: "e.g. Joel Coen, Ethan Coen", class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-xs ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" %>
          <p class="mt-3 text-sm leading-6 text-gray-600">If there are multiple directors, enter them as a comma-separated list.</p>
        </div>
        <div class="mb-4">
          <%= form.label :country, class: "block text-gray-700 text-sm font-bold mb-2" %>
          <div id="film-countries">
            <% if film.country.present? %>
              <% film.country.split(",").map(&:strip).each do |country_code| %>
                <%= render partial: "admin/films/country_select", locals: { country: country_code } %>
              <% end %>
            <% else %>
              <%= render partial: "admin/films/country_select" %>
            <% end %>
          </div>
          <%= link_to "Add another country", admin_films_add_country_path, data: { "turbo-stream": true }, class: "inline-block mt-4 bg-indigo-500 hover:bg-indigo-700 text-white font-semibold py-1 px-2 rounded-sm text-xs" %>
        </div>
      <% end %>

      <div class="mb-4">
        <%= field_set_tag do %>
          <legend class="block text-gray-700 text-sm font-bold mb-2">Category</legend>

          <% if edition.categories.any? %>
            <% edition.categories.order(:name).all.each do |category| %>
              <%= selection_form.label :category_id, value: category.id, class: "block text-gray-700 text-sm font-semibold mb-3" do %>
                <%= selection_form.radio_button :category_id, category.id, class: "text-indigo-500 focus:ring-indigo-500" %>
                <span class="inline-block ml-2"><%= category.name %></span>
              <% end %>
            <% end %>
          <% end %>

          <%= selection_form.label :category_id, value: "-1", class: "block text-gray-700 text-sm font-semibold" do %>
            <%= selection_form.radio_button :category_id, "-1", class: "peer text-indigo-500 focus:ring-indigo-500" %> <span class="inline-block ml-2 text-indigo-400 peer-checked:text-indigo-500">Add a new category</span>

            <div class="hidden peer-checked:block mt-3">
              <%= text_field_tag :new_category, nil, placeholder: "e.g. Special Presentations", class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-xs ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" %>
            </div>
          <% end %>
        <% end %>
      </div>

      <div class="my-8 border-t border-b border-t-gray-200 border-b-gray-200 py-2">
        <%= form.label :rateable, class: "block text-gray-700 text-sm font-semibold mb-2" do %>
          <%= form.check_box :rateable, checked: true, class: "text-indigo-500 focus:ring-indigo-500" %> <span class="inline-block ml-2">Rateable?</span>
        <% end %>
        <p class="mt-3 text-sm leading-6 text-gray-600">Uncheck this box if you don't want this film to be rated by critics. Applies to all festivals.</p>
      </div>

      <% if film.tmdb_id.present? %>
        <details>
          <summary class="cursor-pointer text-sm font-semibold text-gray-700 mb-4">TMDB Details</summary>

          <div class="mt-4">
            <%= form.label :tmdb_id, "TMDB ID", class: "block text-gray-700 text-sm font-bold mb-2" %>
            <%= form.text_field :tmdb_id, class: "block w-full rounded-md border-0 py-1.5 text-gray-400 shadow-xs ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6", readonly: true %>
          </div>
          <div class="mt-4">
            <%= form.label :summary, class: "block text-gray-700 text-sm font-bold mb-2" %>
            <%= form.text_area :summary, rows: 4, placeholder: "A brief synopsis of the film", class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-xs ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" %>
          </div>
          <div class="mt-4">
            <%= form.label :release_date, class: "block text-gray-700 text-sm font-bold mb-2" %>
            <%= form.date_field :release_date, class: "block w-full rounded-md border-0 py-1.5 text-gray-400 shadow-xs ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6", readonly: true %>
          </div>
          <div class="mt-4 flex gap-4">
            <div>
              <%= form.label :poster_path, "Poster", class: "block text-gray-700 text-sm font-bold mb-2" %>
              <img class="block w-full h-auto rounded-sm shadow-xs" src="<%= TMDB.poster_url(@film.poster_path) %>" alt="Poster image for <%= @film.title %>">
              <%= form.hidden_field :poster_path, value: @film.poster_path %>
            </div>
            <div class="grow">
              <%= form.label :backdrop_path, "Backdrop", class: "block text-gray-700 text-sm font-bold mb-2" %>
              <img class="block w-full h-auto rounded-sm shadow-xs" src="<%= TMDB.backdrop_url(@film.backdrop_path) %>" alt="Backdrop image for <%= @film.title %>">
              <%= form.hidden_field :backdrop_path, value: @film.backdrop_path %>
            </div>
          </div>
        </details>
      <% end %>

      <div class="flex items-center justify-between mt-8">
        <%= form.submit class: "bg-indigo-500 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-sm focus:outline-hidden focus:shadow-outline" %>
      </div>
    <% end %>
  <% end %>
<% end %>

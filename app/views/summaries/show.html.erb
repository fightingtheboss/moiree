<%= render partial: "shared/edition_nav", locals: { edition: @edition } %>

<% title("Festival summary for #{@edition.name}") %>
<% description("Summary of ratings for #{@edition.code}") %>
<% open_graph(@edition) %>

<div>
  <header class="p-4 text-left w-full">
    <div class="flex justify-between">
      <div>
        <h2 class="font-normal text-xs uppercase"><%= @edition.name %></h2>
        <h1 class="font-semibold text-2xl leading-tight">Festival summary for <span class="font-extrabold"><%= @edition.code %></span></h1>
        <p class="mt-1 text-sm">Ratings are out of 5.0</p>
      </div>
    </div>
  </header>

  <% if @edition.summary? && @edition.ratings.any? %>
    <div class="flex flex-col gap-2">
      <section>
        <% @selections_for_standalone.each do |category, selections| %>
          <div class="bg-white rounded-lg p-4">
            <h1 class="font-semibold text-2xl mb-4">Top 3 films in <span class="font-extrabold"><%= category.name %></span></h1>
            <% if selections.any? %>
              <ul class="flex flex-col md:flex-row gap-4">
                <% selections.first(3).each_with_index do |selection, index| %>
                  <li class="md:w-1/3">
                    <article class="bg-white rounded-lg shadow-md overflow-hidden group hover:shadow-xl transition-shadow h-full">
                      <%= link_to film_path(selection.film, anchor: dom_id(@edition)), class: "block h-full" do %>
                        <div class="relative aspect-2/3 overflow-hidden bg-indigo-100 hidden md:block">
                          <% if selection.film.poster_path.present? %>
                            <img
                              src="<%= TMDB.poster_url(selection.film.poster_path, size: 'w500') %>"
                              alt="<%= selection.film.title %> poster"
                              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                              loading="lazy"
                            >
                          <% else %>
                            <div class="w-full h-full bg-radial-gradient flex items-center justify-center">
                              <span class="text-indigo-300/25 font-black text-6xl italic text-center"><%= selection.film.title %></span>
                            </div>
                          <% end %>

                          <div class="absolute top-4 right-4 w-8 h-8 rounded-md bg-indigo-700 shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)] grid place-content-center">
                            <span class="font-bold text-lg text-white"><%= index + 1 %></span>
                          </div>
                        </div>

                        <div class="p-5">
                          <h3 class="font-bold text-lg text-indigo-900 group-hover:text-indigo-700 transition-colors leading-tight mb-1"><%= selection.film.title %></h3>
                          <p class="text-sm text-gray-600"><%= selection.film.director %></p>
                          <p class="text-sm text-slate-500 mt-2">Avg <strong><%= number_with_precision(selection.average_rating, precision: 1) %></strong> from <%= pluralize(selection.ratings.all.size, "rating") %></p>
                        </div>
                      <% end %>
                    </article>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <p class="mt-2 p-2 font-semibold text-center leading-tight rounded-lg bg-[repeating-linear-gradient(-45deg,#e0e7ff_0px,#e0e7ff_4px,#eef2ff_4px,#eef2ff_8px)]">Not enough ratings yet, check back soon</p>
            <% end %>
          </div>
        <% end %>
      </section>

      <section>
        <div class="bg-white rounded-lg p-4">
          <h1 class="font-semibold text-xl mb-2">Top 5 films in all <%= @selections_for_standalone.any? ? "other" : "" %> categories</h1>
          <% if @selections_for_others.any? %>
            <ul class="flex flex-col md:flex-row gap-4">
              <% @selections_for_others.limit(5).each_with_index do |selection, index| %>
                <li class="md:w-1/5">
                  <article class="bg-white rounded-lg shadow-md overflow-hidden group hover:shadow-xl transition-shadow h-full">
                    <%= link_to film_path(selection.film, anchor: dom_id(@edition)), class: "block h-full" do %>
                      <div class="relative aspect-2/3 overflow-hidden bg-indigo-100 hidden md:block">
                        <% if selection.film.poster_path.present? %>
                          <img
                            src="<%= TMDB.poster_url(selection.film.poster_path, size: 'w500') %>"
                            alt="<%= selection.film.title %> poster"
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                            loading="lazy"
                          >
                        <% else %>
                          <div class="w-full h-full bg-radial-gradient flex items-center justify-center">
                            <span class="text-indigo-300/25 font-black text-4xl italic text-center"><%= selection.film.title %></span>
                          </div>
                        <% end %>

                        <div class="absolute top-3 right-3 w-8 h-8 rounded-md bg-indigo-700/85 shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)] grid place-content-center">
                          <span class="font-bold text-lg text-white"><%= index + 1 %></span>
                        </div>
                      </div>

                      <div class="p-4">
                        <h4 class="text-xs uppercase tracking-wide font-light mb-1 text-gray-500"><%= selection.category.name %></h4>
                        <h3 class="font-bold text-sm text-indigo-900 group-hover:text-indigo-700 transition-colors leading-tight mb-1"><%= selection.film.title %></h3>
                        <p class="text-xs text-gray-600"><%= selection.film.director %></p>
                        <p class="text-xs text-slate-500 mt-1">Avg <strong><%= number_with_precision(selection.average_rating, precision: 1) %></strong> from <%= pluralize(selection.ratings.all.size, "rating") %></p>
                      </div>
                    <% end %>
                  </article>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="mt-2 p-2 font-semibold text-center leading-tight rounded-lg bg-[repeating-linear-gradient(-45deg,#e0e7ff_0px,#e0e7ff_4px,#eef2ff_4px,#eef2ff_8px)]">Not enough ratings yet, check back soon</p>
          <% end %>
        </div>
      </section>

      <div class="grid gap-2 md:grid-cols-12">
        <section class="md:col-span-4 self-stretch">
          <div class="bg-white rounded-lg p-4 h-full flex flex-col">
            <h1 class="text-xl font-semibold">Bombe MoirÃ©e for <%= @edition.code %> ðŸ’£</h1>
            <h2 class="text-sm mb-2">Worst rated film of the festival</h2>
            <% if @bombe_moiree %>
              <div class="shadow-md rounded-lg mb-2 p-4 bg-radial-gradient hover:shadow-xl transition-shadow flex items-center gap-4">
                <% if @bombe_moiree.film.poster_path.present? %>
                  <img
                    src="<%= TMDB.poster_url(@bombe_moiree.film.poster_path, size: 'w92') %>"
                    alt="<%= @bombe_moiree.film.title %> poster"
                    class="w-12 h-18 object-cover rounded shadow-sm shrink-0"
                    loading="lazy"
                  >
                <% end %>
                <div>
                  <h4 class="text-xs uppercase tracking-wide font-light mb-1"><%= @bombe_moiree.category.name %></h4>
                  <h2 class="font-medium leading-tight"><%= link_to @bombe_moiree.film.title, film_path(@bombe_moiree.film, anchor: dom_id(@edition)), class: "hover:text-indigo-700 hover:italic" %></h2>
                  <h3 class="text-xs my-0.5"><%= @bombe_moiree.film.director %></h3>
                  <p class="text-xs text-slate-500">Avg <strong><%= number_with_precision(@bombe_moiree.average_rating, precision: 1) %></strong> from <%= pluralize(@bombe_moiree.ratings.size, "rating") %></p>
                </div>
              </div>
              <ul class="grid grid-flow-col gap-1 h-24 items-end my-8">
                <% @bombe_moiree_histogram.each do |score, count| %>
                  <li style="--histogramHeight:<%= histogram_height(count, @bombe_moiree_histogram.values.max) %>" class="relative bg-linear-to-b from-indigo-500 to-indigo-700 rounded h-(--histogramHeight)" title="<%= histogram_title(score, count) %>">
                    <span class="absolute top-2 left-0 right-0 text-xs text-white text-center font-semibold"><%= count %></span>
                    <span class="absolute -bottom-6 left-0 right-0 text-xs text-center"><%= display_rating(score) %></span>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <div class="grow flex flex-col justify-center items-center mt-2 p-2 rounded-lg bg-[repeating-linear-gradient(-45deg,#e0e7ff_0px,#e0e7ff_4px,#eef2ff_4px,#eef2ff_8px)]">
                <p class="font-semibold text-center leading-tight">Not enough ratings yet, check back soon</p>
              </div>
            <% end %>
          </div>
        </section>

        <section class="md:col-span-8 self-stretch">
          <div class="bg-white rounded-lg p-4 h-full flex flex-col">
            <h1 class="text-xl font-semibold">Most divisive film for <%= @edition.code %></h1>
            <h2 class="text-sm mb-2">The widest variance of ratings</h2>
            <% if @most_divisive %>
              <div class="shadow-md rounded-lg mb-2 p-4 bg-radial-gradient hover:shadow-xl transition-shadow flex items-center gap-4">
                <% if @most_divisive.film.poster_path.present? %>
                  <img
                    src="<%= TMDB.poster_url(@most_divisive.film.poster_path, size: 'w92') %>"
                    alt="<%= @most_divisive.film.title %> poster"
                    class="w-12 h-18 object-cover rounded shadow-sm shrink-0"
                    loading="lazy"
                  >
                <% end %>
                <div>
                  <h4 class="text-xs uppercase tracking-wide font-light mb-1"><%= @most_divisive.category.name %></h4>
                  <h2 class="font-medium leading-tight"><%= link_to @most_divisive.film.title, film_path(@most_divisive.film, anchor: dom_id(@edition)), class: "hover:text-indigo-700 hover:italic" %></h2>
                  <h3 class="text-xs my-0.5"><%= @most_divisive.film.director %></h3>
                  <p class="text-xs text-slate-500">Avg <strong><%= number_with_precision(@most_divisive.average_rating, precision: 1) %></strong> from <%= pluralize(@most_divisive.ratings.all.size, "rating") %></p>
                </div>
              </div>
              <ul class="grid grid-flow-col gap-1 h-24 items-end my-8">
                <% @most_divisive_histogram.each do |score, count| %>
                  <li style="--histogramHeight:<%= histogram_height(count, @most_divisive_histogram.values.max) %>" class="relative bg-linear-to-b from-indigo-500 to-indigo-700 rounded h-(--histogramHeight)" title="<%= histogram_title(score, count) %>">
                    <span class="absolute top-2 left-0 right-0 text-xs text-white text-center font-semibold"><%= count %></span>
                    <span class="absolute -bottom-6 left-0 right-0 text-xs text-center"><%= display_rating(score) %></span>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <div class="grow flex flex-col justify-center items-center mt-2 p-2 rounded-lg bg-[repeating-linear-gradient(-45deg,#e0e7ff_0px,#e0e7ff_4px,#eef2ff_4px,#eef2ff_8px)]">
                <p class="font-semibold text-center leading-tight">Not enough ratings yet, check back soon</p>
              </div>
            <% end %>
          </div>
        </section>

        <section class="md:col-span-6 self-stretch">
          <div class="bg-white rounded-lg shadow-md p-4 h-full flex flex-col">
            <h1 class="text-xl font-semibold mb-2 text-center">Number of ðŸ”¥ ratings</h1>
            <p class="text-center bg-radial-gradient rounded-lg px-2 py-4 text-8xl tracking-tighter font-semibold"><%= @five_star_ratings.count %></p>
            <% if @five_star_ratings.any? %>
              <ul class="mt-4 bg-indigo-50 rounded-lg p-4 divide-y divide-indigo-100">
                <% @five_star_ratings.each do |rating| %>
                  <li class="py-2">
                    <p class="leading-tight"><strong><%= rating.critic.name %></strong> appreciated <%= link_to rating.film.title, film_path(rating.film, anchor: dom_id(@edition)), class: "font-medium hover:text-indigo-700 hover:italic" %></p>
                    <% if rating.impression.present? %>
                      <p class="mt-1 text-sm text-gray-600 italic line-clamp-2">"<%= rating.impression %>"</p>
                    <% end %>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <div class="grow flex items-center justify-center mt-4 rounded-lg bg-[repeating-linear-gradient(-45deg,#e0e7ff80_0px,#e0e7ff80_4px,#eef2ff80_4px,#eef2ff80_8px)]">
                <p class="p-4 font-semibold text-center text-sm leading-tight">No perfect scores</p>
              </div>
            <% end %>
          </div>
        </section>

        <section class="md:col-span-6 self-stretch">
          <div class="bg-white rounded-lg shadow-md p-4 h-full flex flex-col">
            <h1 class="text-xl font-semibold mb-2 text-center">Number of ðŸ’£ ratings</h1>
            <p class="text-center bg-radial-gradient rounded-lg px-2 py-4 text-8xl tracking-tighter font-semibold"><%= @zero_star_ratings.count %></p>
            <% if @zero_star_ratings.any? %>
              <ul class="mt-4 bg-indigo-50 rounded-lg p-4 divide-y divide-indigo-100">
                <% @zero_star_ratings.each do |rating| %>
                  <li class="py-2">
                    <p class="leading-tight"><strong><%= rating.critic.name %></strong> bombed <%= link_to rating.film.title, film_path(rating.film, anchor: dom_id(@edition)), class: "font-medium hover:text-indigo-700 hover:italic" %></p>
                    <% if rating.impression.present? %>
                      <p class="mt-1 text-sm text-gray-600 italic line-clamp-2">"<%= rating.impression %>"</p>
                    <% end %>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <div class="grow flex items-center justify-center mt-4 rounded-lg bg-[repeating-linear-gradient(-45deg,#e0e7ff80_0px,#e0e7ff80_4px,#eef2ff80_4px,#eef2ff80_8px)]">
                <p class="p-4 font-semibold text-center text-sm leading-tight">No bombs dropped</p>
              </div>
            <% end %>
          </div>
        </section>
      </div>
    </div>
  <% else %>
    <section class="grid h-[calc(100vh-10.75rem)]">
      <p class="place-content-center place-items-center text-center leading-tight">This view will start filling up when the festival is underway</p>
    </section>
  <% end %>
</div>
